<!DOCTYPE html> 
<html> 
<head> 
	<title>Balous Catdoor</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0-beta.1/jquery.mobile-1.3.0-beta.1.min.css" />

	<style type="text/css" media="screen">
			.containing-element .ui-slider-switch { width: 12em; }
	</style>

	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.0-beta.1/jquery.mobile-1.3.0-beta.1.min.js"></script>

	<script>

		function GetFormatedTimeString(currentTime)
		{
			var hours = currentTime.getHours();
			var minutes = currentTime.getMinutes();

			if (minutes < 10)
				minutes = "0" + minutes;
			if (hours < 10)
				hours = "0" + hours;

			return hours + ":" + minutes
		}

		function UpdateBalou()
		{
			$.ajax(
			{
				type: "GET",
				url: "/balou",
				cache: false
			}).done(function(json)
			{
				var date = new Date(json.last_update);

				if (json.balou_state == "indoor")
				{
					$("#balou-state").html("Balou ist zuhause seit ");
				}
				else if (json.balou_state == "outdoor")
				{
					$("#balou-state").html("Balou ist draussen seit ");
				}
				$("#balou-state").append(GetFormatedTimeString(date) + " Uhr");
			});
		}

		function UpdateDoor()
		{
			$.ajax(
			{
				type: "GET",
				url: "/DoorService/Door",
				cache: false
			}).done(function(json)
			{
				if (json.Unlocked == false)
				{
					$("#catdoor-state").html("Catdoor ist geschlossen");
				}
				else if (json.Unlocked == true)
				{
					$("#catdoor-state").html("Catdoor ist offen");
				}

				$("#door-flip").val(json.door_state).slider('refresh');
			});
		}

		function UpdateLog()
		{
			$.ajax(
			{
				type: "GET",
				url: "/log",
				cache: false
			}).done(function(json)
			{				
				$(json).each(function(index){
					$('[data-role="listview"]').append('<li id="listitem">' + this.time + ": " + this.name + ", " + this.description + '</li>');
				});
				$('[data-role="listview"]').listview('refresh');
			})
		}

		function UpdateSchedule()
		{
			$.ajax(
			{
				type: "GET",
				url: "/schedule",
				cache: false
			}).done(function(json)
			{
				var opentime = new Date(json.opentime);
				var closetime = new Date(json.closetime);

				$("#schedule").html("Nach Plan ist Catdoor heute von ");
				$("#schedule").append(GetFormatedTimeString(opentime) + " Uhr");
				$("#schedule").append(" bis " + GetFormatedTimeString(closetime) + " Uhr offen.");
			});
		}

		function PutDoor()
		{
			if ($("#door-flip").val() == "unlocked")
			{
				$.ajax(
				{
					type: "POST",
					url: "/DoorService/Door",
					data: { "Unlocked": true },
					dataType: "json",
					contentType: "application/json" 
				}).done(function(json)
				{
					UpdateDoor();
				});				
			}

			else
			{
				$.ajax(
				{
					type: "POST",
					url: "/DoorService/Door",
					data: { "Unlocked": false },
					dataType: "json",
					contentType: "application/json" 
				}).done(function(json)
				{
					UpdateDoor();
				});				
			}


		}

		$( document ).bind( 'mobileinit', function()
		{
  			$.mobile.loader.prototype.options.text = "loading";
			$.mobile.loader.prototype.options.textVisible = false;
			$.mobile.loader.prototype.options.theme = "a";
			$.mobile.loader.prototype.options.html = "";
		});

		$(document).ready(function()
		{
			setInterval(function()
			{
				// UpdateBalou();
				UpdateDoor();
				// UpdateSchedule();
			}, 10000);

			$("#door-flip").bind("change", function(event, ui)
			{
				PutDoor();
			});

			$.mobile.loading( 'show' );
			// UpdateBalou();
			UpdateDoor();
			//UpdateLog();
			// UpdateSchedule();
			$.mobile.loading( 'hide' );
		});
	</script>

</head> 
<body> 

<div data-role="page">

	<div data-role="header">
		<h1>Balous Catdoor</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Status</h2>
		<p id="balou-state"></p>
		<p id="catdoor-state"></p>
		<p id="schedule"></p>

		<h2>Einstellungen</h2>		
		<div class="containing-element">
			<select name="flip-min" id="door-flip" data-role="slider">
				<option value="locked">Geschlossen</option>
				<option value="unlocked">Offen</option>
			</select>
		</div>
		<h2>Event Log</h2>
		<div data-role="fieldcontain">
    		<ul id="logs" data-role="listview" data-divider-theme="b" data-inset="true"></ul>
		</div>
	</div><!-- /content -->

</div><!-- /page -->

</body>
</html>