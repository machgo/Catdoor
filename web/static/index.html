<!DOCTYPE html> 
<html> 
<head> 
	<title>Balous Catdoor</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
	<link rel="stylesheet" href="swipebox.css">

	<style type="text/css" media="screen">
			.containing-element .ui-slider-switch { width: 12em; }
	</style>

	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js"></script>
	<script src="jquery.swipebox.js"></script>

	<script>

		function GetFormatedTimeString(currentTime)
		{
			var hours = currentTime.getHours();
			var minutes = currentTime.getMinutes();

			if (minutes < 10)
				minutes = "0" + minutes;
			if (hours < 10)
				hours = "0" + hours;

			return hours + ":" + minutes
		}

		function UpdateDoor()
		{
			$.ajax(
			{
				type: "GET",
				url: "/DoorService/Door",
				cache: false
			}).done(function(json)
			{
				if (json.Unlocked == false)
				{
					$("#catdoor-state").html("Catdoor ist geschlossen");
					$("#door-flip").val("locked").slider('refresh');
				}
				else if (json.Unlocked == true)
				{
					$("#catdoor-state").html("Catdoor ist offen");
					$("#door-flip").val("unlocked").slider('refresh');
				}
			});
		}

		function timeConvert(date){
		    var miliseconds = date.replace(/(^.*\()|([+-].*$)/g, '');
		    miliseconds = parseInt(miliseconds);
		    return new Date(miliseconds);
		}

		function UpdateLog()
		{
			$.ajax(
			{
				type: "GET",
				url: "/DoorService/LogEntries",
				cache: false
			}).done(function(json)
			{				
				$(json).each(function(index){
					var date = timeConvert(this.TimeStamp)

					$('[data-role="listview"]').append('<li id="listitem">' + date + ": " + this.Title + ", " + this.Message + '</li>');
				});
				$('[data-role="listview"]').listview('refresh');
			})
		}

		function PutDoor()
		{
			if ($("#door-flip").val() == "unlocked")
			{
				$.ajax(
				{
					type: "POST",
					url: "/DoorService/Door",
					data: '{ "Unlocked": true }',
					dataType: "json",
					contentType: "application/json" 
				}).done(function(json)
				{
					UpdateDoor();
				});				
			}

			else
			{
				$.ajax(
				{
					type: "POST",
					url: "/DoorService/Door",
					data: '{ "Unlocked": false }',
					dataType: "json",
					contentType: "application/json" 
				}).done(function(json)
				{
					UpdateDoor();
				});				
			}
		}

		$( document ).bind( 'mobileinit', function()
		{
  			$.mobile.loader.prototype.options.text = "loading";
			$.mobile.loader.prototype.options.textVisible = false;
			$.mobile.loader.prototype.options.theme = "a";
			$.mobile.loader.prototype.options.html = "";
		});

		$(document).ready(function()
		{
			jQuery(function($) {
				$(".swipebox").swipebox();
			});

			setInterval(function()
			{
				UpdateDoor();
			}, 10000);

			$("#door-flip").bind("change", function(event, ui)
			{
				PutDoor();
			});

			$("#galleryButton").click(function(event){
				event.preventDefault();

				$.ajax(
				{
					type: "GET",
					url: "/DoorService/Pictures",
					cache: false
				}).done(function(json)
				{
					$.swipebox(json.lastPics);
				});
			});



			$.mobile.loading( 'show' );
			// UpdateBalou();
			UpdateDoor();
			UpdateLog();
			// UpdateSchedule();
			$.mobile.loading( 'hide' );
		});
	</script>

</head> 
<body> 

<div data-role="page">

	<div data-role="header">
		<h1>Balous Catdoor</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Status</h2>
		<p id="catdoor-state"></p>

		<h2>Einstellungen</h2>		
		<div class="containing-element">
			<select name="flip-min" id="door-flip" data-role="slider">
				<option value="locked">Geschlossen</option>
				<option value="unlocked">Offen</option>
			</select>
		</div>
		<h2>Fotos und Events</h2>
		<div data-role="containing-element">
			<input type="button" id="galleryButton" value="Gallery"/>
		</div>
		<div data-role="fieldcontain">
    		<ul id="logs" data-role="listview" data-divider-theme="b" data-inset="true"></ul>
		</div>
	</div><!-- /content -->

</div><!-- /page -->

</body>
</html>